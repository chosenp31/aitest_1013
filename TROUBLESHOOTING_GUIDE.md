# 「つながりを申請」ボタン問題 トラブルシューティングガイド

## 📋 問題の概要

LinkedInの「つながりを申請」ボタンが検出できず、自動送信が失敗する問題の解決ガイドです。

---

## 🛠️ 解決手順

### ステップ1: デバッグツールで原因を特定

まず、デバッグ専用スクリプトを実行して詳細情報を収集します。

```bash
cd ~/aitest_1013
source venv/bin/activate
python3 aiagent/linkedin_button_debugger.py
```

**実行後の流れ:**
1. Chromeブラウザが起動
2. LinkedInに手動でログイン
3. デバッグしたいプロフィールURLを入力
4. 自動的にスクリーンショット・HTML・JSON結果を保存

**出力ファイルの場所:**
```
debug_output/
├── screenshot_20251024_120000.png      # ページのスクリーンショット
├── page_source_20251024_120000.html    # HTMLソースコード
└── debug_result_20251024_120000.json   # ボタン検出の詳細結果
```

**debug_result_*.json の見方:**

```json
{
  "main": {"found": true},              // <main>タグが見つかったか
  "h1": {"found": true, "text": "名前"},  // プロフィール名要素
  "allButtons": [...],                  // ページ内の全ボタン情報
  "connectButtons": [...],              // 「つながりを申請」候補
  "leftButtons": [...],                 // 左半分領域のボタン
  "selectedButton": {                   // 選択されたボタン
    "found": true,
    "text": "つながりを申請",
    "position": {"x": 100, "y": 200}
  }
}
```

---

### ステップ2: 原因の分析

#### ケース1: `"selectedButton": {"found": false}` の場合

**原因:** ボタンが検出できていない

**確認ポイント:**
- `connectButtons` の配列が空 → ボタン自体が存在しない（既接続/保留中の可能性）
- `leftButtons` の配列が空 → ボタンが右側にある（UIレイアウト変更の可能性）
- `h1` が見つからない → ページ構造が変わった

**対処法:**
1. スクリーンショットを目視確認
2. 実際に「つながりを申請」ボタンが表示されているか確認
3. ボタンのテキストが「Connect」か「つながりを申請」か確認
4. ボタンが画面右側にある場合は、検出ロジックの修正が必要

---

#### ケース2: `selectedButton` は検出されているがクリックできない

**原因:** 要素は見つかっているがクリックイベントが効かない

**確認ポイント:**
- ボタンが他の要素に隠されている
- Shadow DOMの内部にある
- iframeの中にある

**対処法:**
改善版スクリプトの戦略2・戦略3を試す（自動的に試行されます）

---

#### ケース3: ボタンが「つながっています」「保留中」になっている

**原因:** 既に接続済み、またはリクエスト送信済み

**対処法:**
改善版スクリプトは自動的にスキップします。`data/messages.csv`から該当ユーザーを削除してください。

---

### ステップ3: 改善版スクリプトで実行

デバッグ結果を確認したら、改善版スクリプトで実際に送信します。

```bash
python3 aiagent/linkedin_pipeline_improved.py
```

**改善版の特徴:**

1. **3つの検出戦略を順番に試行**
   - 戦略1: JavaScript詳細検出（元のロジック）
   - 戦略2: XPath直接検索（シンプル）
   - 戦略3: 全ボタンスキャン（最も広範囲）

2. **接続状態の事前チェック**
   - 既につながっている → 自動スキップ
   - 保留中 → 自動スキップ

3. **詳細なログ出力**
   - 各戦略の試行結果を表示
   - 成功・スキップ・エラーの件数を集計

4. **エラー時の自動スクリーンショット**
   - `debug_output/error_*.png` に保存
   - 失敗時の画面を後から確認可能

5. **送信結果のCSV記録**
   - `data/logs.csv` に詳細を保存
   - 日時、名前、URL、結果、エラー内容を記録

---

## 🔍 よくある問題と解決策

### 問題1: 全戦略でボタン検出失敗

**症状:**
```
❌ すべての戦略でボタン検出失敗
```

**原因と対処:**
1. **LinkedInのUI変更**
   - 対処: ボタンのHTML構造を確認し、検出ロジックを更新
   - 確認方法: Chrome DevToolsで要素を検査

2. **プロフィールの種類が異なる**
   - 企業ページ、グループなどは構造が違う
   - 対処: 個人プロフィールのみを対象にする

3. **ログイン状態の問題**
   - 対処: 一度ログアウトして再ログイン

---

### 問題2: 「挨拶なしで送信」ボタンが見つからない

**症状:**
```
⚠️ 『挨拶なしで送信』ボタンが見つかりません。
```

**原因と対処:**
1. **ダイアログが表示されていない**
   - 待機時間が短い
   - 対処: `linkedin_pipeline_improved.py` の `time.sleep(2.0)` を増やす（3.0など）

2. **ボタンのテキストが異なる**
   - LinkedIn UIの言語設定によって変わる
   - 対処: 英語版の "Send without a note" も検出するようになっています

3. **招待制限に達している**
   - LinkedInの週次制限（通常50-100件）
   - 対処: 時間をおいてから再実行

---

### 問題3: クリック後に反応がない

**症状:**
- ボタン検出は成功するがクリックイベントが無反応

**対処法:**
1. **execute_scriptクリックを使用**（既に実装済み）
   ```python
   driver.execute_script("arguments[0].click();", btn)
   ```

2. **スクロール位置を調整**（既に実装済み）
   ```python
   driver.execute_script(
       "arguments[0].scrollIntoView({behavior:'smooth', block:'center'});",
       btn
   )
   ```

3. **待機時間を増やす**
   - `time.sleep(1.0)` を `time.sleep(2.0)` に変更

---

## 📊 ログファイルの確認

### 送信ログ (`data/logs.csv`)

```csv
date,name,url,result,error,details
2025-10-24 12:00:00,山田太郎,https://...,success,,sent_without_note
2025-10-24 12:01:00,佐藤花子,https://...,skip,既接続,already_connected
2025-10-24 12:02:00,鈴木一郎,https://...,error,ボタン未検出,
```

**result列の種類:**
- `success`: 送信成功
- `skip`: スキップ（既接続、保留中、URLなし）
- `error`: エラー発生

---

## 🚀 次のステップ

### 1. 送信件数を増やす

`linkedin_pipeline_improved.py` の設定を変更:

```python
LIMIT = 10  # 送信上限を10件に
DELAY_RANGE = (5, 10)  # 送信間隔を5-10秒に
```

### 2. messages.csvの準備

送信対象リストを準備:

```csv
name,url,message
山田太郎,https://www.linkedin.com/in/example1/,よろしくお願いします
佐藤花子,https://www.linkedin.com/in/example2/,ご挨拶させてください
```

**注意:** 改善版では`message`列は使用されず、挨拶なしで送信します。
メッセージ付き送信が必要な場合は別途実装が必要です。

---

## 📞 トラブルが解決しない場合

以下の情報を収集してください:

1. `debug_output/` フォルダ内のファイル
   - スクリーンショット
   - HTMLソース
   - JSON結果

2. `data/logs.csv` の内容

3. エラーメッセージの全文

4. LinkedIn UIの言語設定（日本語 or 英語）

5. プロフィールURL（プライバシーに配慮）

これらの情報を元に、検出ロジックのカスタマイズが可能です。
